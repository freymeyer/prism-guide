# DENR Personnel Workflow Documentation

## üìã Overview

This document provides comprehensive documentation for DENR (Department of Environment and Natural Resources) Personnel users in the PRISM-Matutum system. DENR Personnel have oversight and reporting access to view biodiversity monitoring data and generated reports.

**Role Code:** `denr`  
**Primary Function:** Data viewing, report access, and oversight

---

## üéØ Role Definition & Capabilities

### What DENR Personnel Can Do:
- ‚úÖ View biodiversity data and observations
- ‚úÖ Access generated reports and report archives
- ‚úÖ View data visualizations and analytics
- ‚úÖ Export data for official reporting
- ‚úÖ Access interactive maps showing observation locations
- ‚úÖ View species checklists and information
- ‚úÖ Download shapefiles for GIS analysis
- ‚úÖ View system statistics and summaries

### What DENR Personnel Cannot Do:
- ‚ùå Validate or approve submissions (not a validator)
- ‚ùå Edit or delete data
- ‚ùå Manage users or system configuration
- ‚ùå Submit field data (not a data collector)
- ‚ùå Modify choice lists or system settings

---

## üè† 1. DENR Dashboard

**URL:** `/dashboard/denr/`  
**View:** `DENRDashboardView` ([views_dashboard.py](dashboard/views_dashboard.py#L800-L850))  
**Template:** [denr_dashboard.html](dashboard/templates/dashboard/denr_dashboard.html)

### Dashboard Purpose

Provides DENR Personnel with a high-level overview of biodiversity monitoring activities and quick access to reports.

### Dashboard Components

#### Statistics Cards

| Stat Card | Information Displayed | Purpose |
|-----------|----------------------|---------|
| **Total Species** | Count of catalogued species (Fauna + Flora) | Track biodiversity richness |
| **Total Observations** | Wildlife + Resource Use + Disturbance + Landscape | Monitor field activity volume |
| **Recent Reports** | Count of reports generated this month | Track reporting activity |
| **Protected Areas** | Number of monitored protected areas | Coverage assessment |

#### Quick Access Panels

**Reports & Analytics:**
- Report Archive - View all generated reports
- Data Export Center - Download data in various formats
- Interactive Map - Geographic visualization

**Biodiversity Data:**
- Species List - Browse fauna and flora checklists
- Recent Observations - Latest validated wildlife observations
- Conservation Status Summary - Endangered/Threatened species counts

#### Recent Activity Feed

Shows latest validated observations:
- Species name
- Location
- Date of observation
- PA Staff collector
- Link to observation details

### Access Levels

DENR Personnel can view:
- ‚úÖ All approved/validated data
- ‚úÖ All generated reports
- ‚úÖ System-wide statistics

DENR Personnel cannot access:
- ‚ùå Pending submissions (validation queue)
- ‚ùå Unvalidated data
- ‚ùå Admin configuration pages

---

## üìä 2. Report Access

**URL:** `/dashboard/reports/archive/`  
**Permission Mixin:** `DENRAccessMixin` ([permissions.py](dashboard/permissions.py#L150-L153))

### 2.1 Report Archive

**Available Report Types:**

| Report Type | Description | Format | Access |
|-------------|-------------|--------|--------|
| **GIS-Enhanced Biodiversity Report** | Comprehensive report with maps | PDF | ‚úÖ DENR |
| **Semestral BMS Report** | Bi-annual biodiversity monitoring report | PDF, DOCX | ‚úÖ DENR |
| **Standard BMS Report** | Regular biodiversity monitoring report | PDF | ‚úÖ DENR |
| **Digital Backup Export** | Complete data export | ZIP (CSV + Shapefiles) | ‚úÖ DENR |
| **Custom Report** | User-configured report | PDF, XLSX | ‚úÖ DENR |

### 2.2 Report Archive Interface

**Filters:**
- **Report Type** - Filter by type (GIS, Semestral, Standard, etc.)
- **Date Range** - Filter by generation date
- **Status** - Completed, Pending, Failed
- **Generated By** - User who created the report

**Actions:**
- **Download** - Download report file
- **Preview** - View report in browser (PDF)
- **View Details** - See report parameters and metadata
- **Regenerate** - Create updated version (if permissions allow)

**Displayed Information:**
- Report Name
- Type
- Generation Date
- File Size
- Status (badge)
- Download button

### 2.3 Report Generation

**DENR can request reports via:**

1. **Report Builder** (`/dashboard/reports/builder/`)
   - Select report type
   - Configure parameters:
     - Date range
     - Geographic scope (Region, Province, Municipality)
     - Species filters
     - Observation types
   - Generate report (queued via Celery)
   - Receive notification when ready

2. **Dashboard Quick Links**
   - Pre-configured common reports
   - One-click generation

**Report Parameters:**
```python
{
    'report_type': 'gis_enhanced',
    'date_from': '2026-01-01',
    'date_to': '2026-03-31',
    'region': 'Region XI',
    'province': 'South Cotabato',
    'municipality': 'Lake Sebu',
    'include_maps': True,
    'include_species_list': True,
    'include_photos': True,
}
```

### 2.4 Data Export Center

**URL:** `/dashboard/reports/data-export/`

**Export Options:**

| Export Type | Format | Contents | Use Case |
|-------------|--------|----------|----------|
| **Wildlife Observations** | CSV, Excel | Species, count, location, date | Spreadsheet analysis |
| **Species Checklist** | CSV, PDF | Complete fauna/flora list | Reference |
| **Spatial Data** | Shapefile, GeoJSON | Observations with coordinates | GIS software |
| **Complete Database Dump** | ZIP (Multiple CSVs) | All tables | Backup, external analysis |

**Export Process:**
1. Select export type
2. Configure filters (date range, location, species)
3. Choose format
4. Generate export (background task)
5. Download when ready

**Shapefile Contents:**
- Point layer: Observation locations
- Polygon layer: Protected area boundaries
- Attributes: Species, date, collector, status

---

## üó∫Ô∏è 3. Interactive Map Access

**URL:** `/dashboard/map/`  
**View:** `InteractiveMapView` ([views_gis.py](dashboard/views_gis.py))

### Map Features

**Base Layers:**
- Satellite Imagery (Google Satellite)
- Topographic Map
- OpenStreetMap

**Data Layers (Toggle On/Off):**
- **Protected Areas** - PA boundaries (polygons)
- **Wildlife Observations** - Species sightings (markers)
- **Resource Use Incidents** - Illegal activities (warning icons)
- **Disturbances** - Habitat disturbances (alert icons)
- **Monitoring Locations** - Permanent monitoring sites
- **Transect Routes** - Survey routes (lines)

**Filters:**
- **Date Range** - Filter observations by date
- **Species** - Filter by specific species
- **Conservation Status** - Endangered, Threatened, etc.
- **Observation Type** - Wildlife, Resource Use, Disturbance
- **PA Staff** - Filter by collector

**Map Interactions:**
- Click marker ‚Üí View observation details popup
- Click PA boundary ‚Üí View PA information
- Draw tools ‚Üí Select observations within area
- Export visible data ‚Üí Download as CSV or Shapefile

### GeoJSON API Endpoints

**For Developers:**
```python
# Protected areas
GET /api/geo/protected-areas/
# Returns: GeoJSON FeatureCollection

# Observations
GET /api/geo/observations/?species=macaca&date_from=2026-01-01
# Returns: GeoJSON FeatureCollection with filters

# Transect routes
GET /api/geo/transect-routes/
# Returns: GeoJSON LineString features
```

---

## üìà 4. Biodiversity Analytics Access

**URL:** `/dashboard/analytics/biodiversity/`

### Available Analytics

**1. Species Frequency Analysis**
- Most observed species (bar chart)
- Observation trends over time (line chart)
- Species by conservation status (pie chart)

**2. Population Trends**
- Species population estimates over time
- Growth/decline indicators
- Seasonal patterns

**3. Geographic Distribution**
- Heat map of observation density
- Species range maps
- Protected area coverage

**4. Data Collection Metrics**
- Submissions per month
- PA Staff productivity
- Validation turnaround time

### Visualization Types

| Chart Type | Use Case | Example |
|------------|----------|---------|
| **Bar Chart** | Species counts, Comparisons | Top 10 most observed species |
| **Line Chart** | Trends over time | Observation count per month |
| **Pie Chart** | Proportions | Observations by type (Wildlife/Resource Use/Disturbance) |
| **Heat Map** | Geographic density | Observation hotspots |
| **Scatter Plot** | Correlations | Species richness vs. survey effort |

**Interactive Features:**
- Hover for details
- Click legend to toggle series
- Export chart as PNG or CSV
- Customize date range and filters

---

## ü¶ú 5. Species Information Access

**URL:** `/dashboard/species/`  
**Permission:** `StaffAndCollaboratorAccessMixin`

### Species List

**View Options:**
- **Fauna** - Wildlife species
- **Flora** - Plant species
- **All** - Combined list

**Displayed Information:**
- Scientific Name
- Common Names
- Conservation Status (badge)
- Endemicity Status (Endemic, Native, Introduced)
- Total Observations
- Last Observed Date

**Filters:**
- **Search** - By scientific or common name
- **Conservation Status** - Critically Endangered, Endangered, Vulnerable, etc.
- **Endemicity** - Endemic, Native, Introduced
- **Taxonomic Rank** - Family, Order, Class

### Species Detail View

**URL:** `/dashboard/species/<int:pk>/`

**Sections:**

**A. Taxonomy**
- Kingdom, Phylum, Class, Order, Family, Genus, Species
- Authority (taxonomist who described)

**B. Conservation Information**
- IUCN Red List Status
- CITES Appendix
- National Conservation Status (DAO lists)
- Population Trends

**C. Physical Description**
- For Fauna: Size, weight, coloration, distinguishing features
- For Flora: Height, leaf characteristics, flower/fruit description

**D. Habitat & Ecology**
- Preferred habitat
- Elevation range
- Diet (fauna) or Growing conditions (flora)

**E. Distribution**
- Geographic range
- Endemic areas
- Map of observation locations

**F. Observations**
- List of all validated observations for this species
- Filter by date, location
- View individual observation details

**G. Media Gallery**
- Field photos
- Reference images
- Audio recordings (for fauna with calls)

**H. References & Articles**
- Scientific papers
- Field guides
- Conservation plans

---

## üîç 6. Data Viewing Permissions

### What DENR Can View

**‚úÖ Validated Data:**
- All observations with `validation_status='validation_status_approved'`
- Complete submission details (PA Staff, date, location, remarks)
- Validation history (who validated, when, remarks)

**‚úÖ Aggregated Statistics:**
- System-wide counts and metrics
- Protected area summaries
- Species occurrence data

**‚úÖ Reports:**
- All generated reports
- Report metadata and parameters
- Export data

### What DENR Cannot View

**‚ùå Unvalidated Data:**
- Submissions with `validation_status='---'` (pending)
- Submissions on hold or flagged
- Raw unprocessed Kobo data

**‚ùå Sensitive Operations:**
- Validation workspace
- User approval processes
- System configuration

**Code Reference:**
```python
# Permission Mixin
class DENRAccessMixin(MultiRoleAccessMixin):
    """Restricts access to DENR and Validators"""
    allowed_roles = ['denr', 'validator']
    redirect_url = '/dashboard/'
    
    def handle_no_permission(self):
        messages.error(self.request, "DENR Personnel access required.")
        return redirect(self.redirect_url)
```

**Queryset Filtering:**
```python
# DENR sees only validated data
observations = WildlifeObservation.objects.filter(
    submission__validation_status='validation_status_approved'
).select_related('fauna_species', 'submission')

# Exclude pending/rejected
observations = observations.exclude(
    submission__validation_status__in=['---', 'validation_status_not_approved']
)
```

---

## üß™ 7. Testing Checklist for DENR Personnel

### 7.1 Dashboard Access

- [ ] **Test:** DENR dashboard loads correctly
- [ ] **Test:** Statistics cards show accurate counts
- [ ] **Test:** Quick access links work
- [ ] **Test:** Recent activity feed displays
- [ ] **Test:** Cannot access validation queue (403 error)
- [ ] **Test:** Cannot access admin pages (403 error)

### 7.2 Report Access

- [ ] **Test:** Can view report archive
- [ ] **Test:** Can filter reports by type/date
- [ ] **Test:** Can download completed reports
- [ ] **Test:** Can preview PDF reports
- [ ] **Test:** Can request new reports via builder
- [ ] **Test:** Notification received when report ready
- [ ] **Test:** Cannot delete reports (if not creator)

### 7.3 Data Export

- [ ] **Test:** Can access data export center
- [ ] **Test:** Can export observations to CSV
- [ ] **Test:** Can export species checklist
- [ ] **Test:** Can download shapefiles
- [ ] **Test:** Exported data contains only validated observations
- [ ] **Test:** Export filters work correctly

### 7.4 Map Access

- [ ] **Test:** Interactive map loads
- [ ] **Test:** Can toggle data layers on/off
- [ ] **Test:** Can filter observations by date
- [ ] **Test:** Can filter by species
- [ ] **Test:** Markers display correct information
- [ ] **Test:** Can export visible observations
- [ ] **Test:** GeoJSON API endpoints accessible

### 7.5 Analytics & Visualization

- [ ] **Test:** Can access biodiversity analytics
- [ ] **Test:** Charts render correctly
- [ ] **Test:** Can customize date ranges
- [ ] **Test:** Can export chart data
- [ ] **Test:** Interactive features work (hover, click)

### 7.6 Species Information

- [ ] **Test:** Can view species list
- [ ] **Test:** Can search/filter species
- [ ] **Test:** Species detail page loads
- [ ] **Test:** Taxonomy information displays
- [ ] **Test:** Observation list for species shows validated only
- [ ] **Test:** Media gallery displays images
- [ ] **Test:** Cannot edit species information

### 7.7 Data Integrity

- [ ] **Test:** Only validated observations visible
- [ ] **Test:** Pending submissions NOT visible in lists
- [ ] **Test:** Rejected submissions NOT visible
- [ ] **Test:** Observation counts match filter criteria
- [ ] **Test:** Report data accuracy verified

---

## üõ†Ô∏è 8. Troubleshooting

### Common Issues

#### Issue: "Access denied" when accessing reports

**Cause:** User role is not `denr` or account not approved

**Solution:**
```bash
docker-compose exec web python manage.py shell
>>> from users.models import User
>>> user = User.objects.get(username='denr_username')
>>> user.role
'denr'  # Should be 'denr'
>>> user.account_status
'approved'  # Should be 'approved'
```

#### Issue: Map not loading observations

**Possible Causes:**
1. No validated observations in database
2. JavaScript error
3. GeoJSON API endpoint issue

**Solution:**
- Check browser console for JavaScript errors
- Verify observations exist: `WildlifeObservation.objects.filter(submission__validation_status='validation_status_approved').count()`
- Test API: `/api/geo/observations/` should return GeoJSON

#### Issue: Report generation fails

**Causes:**
- Celery not running
- No data matching report parameters
- File system permission issue

**Solution:**
```bash
# Check Celery status
docker-compose logs -f celery

# Test report generation manually
docker-compose exec web python manage.py shell
>>> from dashboard.report_services import generate_gis_enhanced_report
>>> generate_gis_enhanced_report(user_id=1, params={...})
```

#### Issue: Cannot export shapefiles

**Cause:** GDAL library not installed

**Solution:**
```bash
# Check GDAL installation
docker-compose exec web python -c "from osgeo import gdal; print(gdal.__version__)"

# If missing, install in Dockerfile
RUN apt-get update && apt-get install -y gdal-bin libgdal-dev
```

---

## üìö 9. Best Practices for DENR Personnel

### 9.1 Report Usage

**When to Generate Reports:**
- Quarterly: Standard BMS Reports for regular monitoring
- Semestral: Comprehensive Semestral Reports for DENR submission
- Ad-hoc: Custom reports for specific queries or incidents

**Report Naming Convention:**
```
BMS_[Type]_[Location]_[DateRange]_[GeneratedDate]
Example: BMS_Semestral_RegionXI_Jan-Jun2026_20260701
```

### 9.2 Data Interpretation

**Observation Count Considerations:**
- Higher counts ‚â† higher population (may reflect survey effort)
- Compare with survey effort metrics
- Consider seasonal variations
- Account for validator approval rates

**Species Data Quality:**
- Check observation dates for temporal relevance
- Verify GPS accuracy in observation details
- Review validation remarks for data quality notes
- Cross-reference with field photos when available

### 9.3 External Reporting

**When using PRISM data for official DENR reports:**

1. **Always use validated data only**
2. **Cite data source:** "PRISM-Matutum Biodiversity Monitoring System, [Date Range]"
3. **Include data quality notes:** Mention GPS accuracy, validation rate
4. **Export complete datasets:** Use Data Export Center for full exports
5. **Archive reports:** Save copies of generated reports for record-keeping

---

## üîó 10. Related Documentation

- **Report Generation:** [REPORT_GENERATION_GUIDE.md](../features/REPORT_GENERATION.md)
- **GIS Features:** [GIS_FEATURES.md](../features/GIS_FEATURES.md)
- **Access Control:** [RBAC_DOCUMENTATION.md](../architecture/RBAC_DOCUMENTATION.md)
- **Species Management:** [SPECIES_MANAGEMENT.md](../features/SPECIES_MANAGEMENT.md)

---

## üìû Support

**For DENR Personnel:**
- Contact System Administrator for access issues
- Report data discrepancies to Validators
- Request custom reports via Report Builder
- Technical support: prism-support@denr.gov.ph

**For Developers:**
- Reference: [views_dashboard.py](dashboard/views_dashboard.py) (DENRDashboardView)
- Permissions: [permissions.py](dashboard/permissions.py) (DENRAccessMixin)
- Reports: [report_services.py](dashboard/report_services.py)
- GIS: [api_geo.py](dashboard/api_geo.py)

---

*Last Updated: January 6, 2026*  
*Part of PRISM-Matutum Capstone Documentation Project*
